---
import { getPostBySlug } from '../../lib/blog';
import { marked } from 'marked';
import SEO from '../../components/SEO.astro';

export const prerender = false;

const { slug } = Astro.params;
const post = await getPostBySlug(slug || '');

if (!post) {
  return Astro.redirect('/blog');
}

const htmlContent = await marked(post.content);

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

const siteUrl = Astro.site?.href || 'https://centrify.io';
const postDate = new Date(post.date);
const updatedDate = post.updated_date ? new Date(post.updated_date) : null;

// JSON-LD Structured Data
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.title,
  description: post.description,
  image: post.image ? `${siteUrl}${post.image}` : `${siteUrl}/logo-icon.png`,
  datePublished: postDate.toISOString(),
  dateModified: (updatedDate || postDate).toISOString(),
  author: {
    '@type': 'Person',
    name: post.author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'Centrify',
    logo: {
      '@type': 'ImageObject',
      url: `${siteUrl}/logo.png`,
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `${siteUrl}/blog/${post.slug}`,
  },
  keywords: post.tags?.join(', ') || '',
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/logo-icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SEO
      title={post.title}
      description={post.description}
      image={post.image}
      article={{
        publishedTime: postDate.toISOString(),
        modifiedTime: updatedDate?.toISOString(),
        author: post.author,
        tags: post.tags || [],
      }}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="Centrify Blog RSS" href="/rss.xml" />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #0EA5E9;
        --primary-dark: #0284C7;
        --teal: #0D9488;
        --cyan: #22D3EE;
        --navy: #0F172A;
        --navy-light: #1E293B;
        --bg-dark: #0F172A;
        --bg-card: #1E293B;
        --text: #F8FAFC;
        --text-muted: #94A3B8;
        --border: #334155;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: 'League Spartan', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-dark);
        color: var(--text);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
      }

      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 24px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .logo {
        display: flex;
        align-items: center;
        text-decoration: none;
      }

      .logo img {
        height: 48px;
        width: auto;
      }

      .nav-links {
        display: flex;
        gap: 32px;
        list-style: none;
      }

      .nav-links a {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 15px;
        font-weight: 500;
        transition: color 0.2s;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: var(--text);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        font-family: 'League Spartan', sans-serif;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--teal) 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(14, 165, 233, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      }

      main {
        padding-top: 120px;
        padding-bottom: 80px;
        min-height: 100vh;
      }

      .article-container {
        max-width: 800px;
        margin: 0 auto;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 32px;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: var(--primary);
      }

      .article-header {
        margin-bottom: 40px;
      }

      .article-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 20px;
      }

      .article-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .article-tags {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .article-tag {
        padding: 4px 12px;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(13, 148, 136, 0.1) 100%);
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 100px;
        font-size: 12px;
        font-weight: 600;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .article-header h1 {
        font-size: 42px;
        font-weight: 700;
        line-height: 1.2;
        letter-spacing: -0.02em;
      }

      .article-image {
        width: 100%;
        height: auto;
        border-radius: 16px;
        margin-bottom: 40px;
      }

      .article-content {
        font-size: 17px;
        line-height: 1.8;
        color: var(--text);
      }

      .article-content h2 {
        font-size: 28px;
        font-weight: 700;
        margin-top: 48px;
        margin-bottom: 20px;
        letter-spacing: -0.01em;
      }

      .article-content h3 {
        font-size: 22px;
        font-weight: 600;
        margin-top: 36px;
        margin-bottom: 16px;
      }

      .article-content p {
        margin-bottom: 24px;
        color: var(--text-muted);
      }

      .article-content a {
        color: var(--primary);
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      .article-content a:hover {
        color: var(--cyan);
      }

      .article-content ul,
      .article-content ol {
        margin-bottom: 24px;
        padding-left: 24px;
        color: var(--text-muted);
      }

      .article-content li {
        margin-bottom: 8px;
      }

      .article-content blockquote {
        border-left: 4px solid var(--primary);
        padding-left: 24px;
        margin: 32px 0;
        font-style: italic;
        color: var(--text-muted);
      }

      .article-content code {
        background: var(--bg-card);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-family: 'Monaco', 'Consolas', monospace;
      }

      .article-content pre {
        background: var(--bg-card);
        padding: 24px;
        border-radius: 12px;
        overflow-x: auto;
        margin-bottom: 24px;
        border: 1px solid var(--border);
      }

      .article-content pre code {
        background: none;
        padding: 0;
      }

      .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 32px 0;
      }

      .article-content strong {
        color: var(--text);
        font-weight: 600;
      }

      footer {
        padding: 48px 0;
        border-top: 1px solid var(--border);
      }

      .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .footer-logo {
        height: 32px;
        width: auto;
      }

      .footer-text {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
      }

      @media (max-width: 968px) {
        .nav-links {
          display: none;
        }

        .mobile-menu-btn {
          display: flex;
        }

        .desktop-cta {
          display: none;
        }
      }

      /* Mobile Menu */
      .mobile-menu-btn {
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 44px;
        height: 44px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        gap: 5px;
        padding: 10px;
      }

      .mobile-menu-btn span {
        display: block;
        width: 20px;
        height: 2px;
        background: var(--text);
        border-radius: 2px;
        transition: all 0.3s;
      }

      .mobile-menu-btn.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }

      .mobile-menu-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .mobile-menu-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translate(5px, -5px);
      }

      .mobile-menu {
        display: none;
        position: fixed;
        top: 73px;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        padding: 24px;
        z-index: 99;
      }

      .mobile-menu.active {
        display: block;
      }

      .mobile-menu ul {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .mobile-menu a {
        display: block;
        padding: 12px 16px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .mobile-menu a:hover,
      .mobile-menu a.active {
        background: var(--bg-card);
        color: var(--text);
      }

      .mobile-menu .btn {
        width: 100%;
        justify-content: center;
        margin-top: 16px;
      }

      @media (max-width: 640px) {
        .article-header h1 {
          font-size: 28px;
        }

        .article-content {
          font-size: 16px;
        }

        .article-content h2 {
          font-size: 24px;
        }

        .footer-content {
          flex-direction: column;
          gap: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a href="/" class="logo">
          <img src="/logo.png" alt="Centrify" />
        </a>
        <ul class="nav-links">
          <li><a href="/#features">Features</a></li>
          <li><a href="/blog" class="active">Blog</a></li>
        </ul>
        <a href="https://app.centrify.io" class="btn btn-primary desktop-cta">Open App</a>
        <button class="mobile-menu-btn" aria-label="Toggle menu" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </nav>
      <div class="mobile-menu">
        <ul>
          <li><a href="/#features">Features</a></li>
          <li><a href="/blog" class="active">Blog</a></li>
        </ul>
        <a href="https://app.centrify.io" class="btn btn-primary">Open App</a>
      </div>
    </header>

    <script>
      const menuBtn = document.querySelector('.mobile-menu-btn');
      const mobileMenu = document.querySelector('.mobile-menu');

      menuBtn?.addEventListener('click', () => {
        menuBtn.classList.toggle('active');
        mobileMenu?.classList.toggle('active');
        menuBtn.setAttribute('aria-expanded',
          menuBtn.classList.contains('active').toString()
        );
      });

      mobileMenu?.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          menuBtn?.classList.remove('active');
          mobileMenu.classList.remove('active');
          menuBtn?.setAttribute('aria-expanded', 'false');
        });
      });
    </script>

    <main>
      <div class="container">
        <article class="article-container">
          <a href="/blog" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Blog
          </a>

          <header class="article-header">
            <div class="article-meta">
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <time datetime={postDate.toISOString()}>
                  {formatDate(post.date)}
                </time>
              </span>
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                {post.author}
              </span>
            </div>

            {post.tags && post.tags.length > 0 && (
              <div class="article-tags">
                {post.tags.map((tag) => (
                  <span class="article-tag">{tag}</span>
                ))}
              </div>
            )}

            <h1>{post.title}</h1>
          </header>

          {post.image && (
            <img
              src={post.image}
              alt={post.image_alt || post.title}
              class="article-image"
            />
          )}

          <div class="article-content" set:html={htmlContent} />
        </article>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="footer-content">
          <img src="/logo.png" alt="Centrify" class="footer-logo" />
          <p class="footer-text">&copy; 2025 Centrify. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
